<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>书币查询工具</title><style>body{font-family:"Microsoft YaHei",sans-serif;margin:20px;background:#fafafa}#main{display:none}#inputData{width:100%;height:200px;font-size:14px;padding:8px;border:1px solid #ccc;border-radius:6px;overflow:auto;background:white}button{padding:6px 14px;margin:8px 4px;border:none;border-radius:6px;background-color:#0078d7;color:white;cursor:pointer;display:inline-flex;align-items:center;height:34px}button:hover{background-color:#005ea6}table{border-collapse:collapse;width:100%;margin-top:10px;background:white}th,td{border:1px solid #ccc;padding:6px;text-align:left;font-size:14px}th{background-color:#f0f0f0}#result{margin-top:20px}pre{width:100%;background:#f9f9f9;border:1px solid #ccc;border-radius:6px;padding:8px;white-space:pre-wrap}input[type=number]{height:34px;font-size:14px;padding:0 8px;border:1px solid #ccc;border-radius:6px;vertical-align:middle;display:inline-flex;align-items:center}</style></head><body>
<div id="passwordArea"><h2>请输入密码</h2><input type="password" id="pwdInput" placeholder="请输入密码"><button onclick="cPwd()">确定</button><p id="pwdMsg" style="color:red;"></p></div>
<div id="main"><h2>📖 书币查询工具</h2><p>复制<a href="https://docs.qq.com/sheet/DUHFGbE54d0JDcWFT?tab=1i6wf3" target="_blank">实时汇总表</a>粘贴至此处（注意不要粘贴为纯文本）：</p><div id="inputData" contenteditable="true" placeholder="粘贴表格内容…"></div><br><input type="number" id="numInput" placeholder="输入所需书币"><button onclick="search()">查询</button><button onclick="copyRes()">复制名单</button><button onclick="copyTableImg()">复制表格为图片</button><button onclick="downloadTableImg()">导出表格为图片</button><div id="result"></div></div>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
const P="weread500bookcoin",K="wenxindushu_pwd_ok";let latestResult=[];
function cPwd(){let v=document.getElementById("pwdInput").value.trim();if(v===P){localStorage.setItem(K,"true");show()}else document.getElementById("pwdMsg").innerText="❌ 密码错误"}
function show(){document.getElementById("passwordArea").style.display="none";document.getElementById("main").style.display="block"}
window.onload=function(){if(localStorage.getItem(K)==="true")show()}
function fmtT(s){if(!s)return"";let d=new Date(s.replace(/-/g,'/'));if(isNaN(d))return s;let diff=Math.floor((new Date()-d)/(864e5));return diff===0?"今日内":diff+"天前"}
const inDiv=document.getElementById("inputData");inDiv.addEventListener("paste",e=>{e.preventDefault();let c=e.clipboardData||window.clipboardData,h=c.getData("text/html"),t=c.getData("text/plain");if(h&&h.includes("<table"))inDiv.innerHTML=h;else{let r=t.trim().split(/\r?\n/).map(r=>r.trim().split(/\s+/)).filter(r=>r[0]&&r[1]&&r[5]),hT="<table><tbody>";for(const rr of r)hT+="<tr>"+rr.map(c=>`<td>${c}</td>`).join("")+"</tr>";hT+="</tbody></table>";inDiv.innerHTML=hT}})
function search(){const c=document.getElementById("inputData"),n=parseFloat(document.getElementById("numInput").value);if(!c.innerHTML.trim()){alert("请先粘贴表格数据");return}if(isNaN(n)){alert("请输入有效数字");return}const t=c.querySelector("table");if(!t){alert("请粘贴包含表格的内容");return}const rows=Array.from(t.rows).slice(1);const parseAccounts=row=>{const cs=row.cells;if(cs.length<6)return[];const nm=cs[0].innerText.trim(),acc=[cs[1].innerText.trim(),cs[2].innerText.trim(),cs[3].innerText.trim(),cs[4].innerText.trim()],sub=cs[5].innerText.trim();let l=[];acc.forEach((txt,k)=>{if(!txt)return;let m=txt.match(/\d+(\.\d+)?/),v=m?parseFloat(m[0]):null;if(v!==null)l.push({群昵称:nm,账号:`账号${k+1}`,书币:txt,提交时间:fmtT(sub),是否过期:/过期|到期/.test(txt),是否完美匹配:v===n,数值:v})});return l};let r1=[];rows.forEach(row=>{r1.push(...parseAccounts(row).filter(a=>a.数值>=n-2&&a.数值<=n+5))});const sR=a=>a.sort((x,y)=>x.是否过期&&!y.是否过期?-1:!x.是否过期&&y.是否过期?1:x.数值-y.数值);sR(r1);let finalR=[];if(r1.length>1){finalR=r1}else{let r2=[...r1],lE=[],lN=[];rows.forEach(row=>{parseAccounts(row).forEach(it=>{if(it.数值>n){it.是否过期?lE.push(it):lN.push(it)}})});lN.sort((a,b)=>a.数值-b.数值);lN=lN.slice(0,3);let comb=[...r2,...lE,...lN];const seen=new Set();finalR=comb.filter(it=>{let k=it.群昵称+it.账号+it.书币;if(seen.has(k))return!1;seen.add(k);return!0});sR(finalR);if(finalR.length===0){let r3=[];rows.forEach(row=>{parseAccounts(row).forEach(it=>{if(it.数值>=n-10&&it.数值<=n)r3.push(it)})});sR(r3);finalR=r3}}latestResult=finalR;const resD=document.getElementById("result");if(finalR.length===0){resD.innerHTML="<p>❌ 未找到匹配结果</p>";return}let h="<table><tr><th>群昵称</th><th>账号</th><th>书币</th><th>更新时间</th></tr>";finalR.forEach(r=>{let st="";if(r.是否过期)st+="color:red;font-weight:bold;";if(r.是否完美匹配)st+="background:yellow;";h+=`<tr><td>${r.群昵称}</td><td>${r.账号}</td><td style="${st}">${r.书币}</td><td>${r.提交时间}</td></tr>`});h+="</table>";resD.innerHTML=h}
function copyRes(){if(!latestResult||latestResult.length===0){alert("无内容可复制");return}const names=[...new Set(latestResult.map(r=>r.群昵称))].join("\n");navigator.clipboard.writeText(names).then(()=>alert("✅ 名单已复制"))}
function downloadTableImg(){const t=document.querySelector("#result table");if(!t){alert("无表格可导出");return}html2canvas(t).then(c=>{let l=document.createElement("a");l.download="查询结果.png";l.href=c.toDataURL();l.click()})}
async function copyTableImg(){const t=document.querySelector("#result table");if(!t){alert("无表格可复制");return}try{const c=await html2canvas(t);c.toBlob(async b=>{if(!b){alert("生成图片失败");return}try{await navigator.clipboard.write([new ClipboardItem({"image/png":b})]);alert("✅ 表格已复制为图片，可直接粘贴到微信")}catch(e){alert("❌ 复制失败");console.error(e)}})}catch(e){alert("❌ 生成图片失败");console.error(e)}}</script>
</body></html>
