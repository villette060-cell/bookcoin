<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ä¹¦å¸æŸ¥è¯¢å·¥å…·v2.4</title>
  <style>
    #passwordArea{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;}
    #pwdInput{width:240px;height:34px;padding:0 8px;font-size:18px;border:1px solid #ccc;border-radius:6px;box-sizing:border-box;text-align:left;}
    #pwdConfirm{margin-top:10px;padding:6px 14px;border:none;border-radius:6px;background-color:#0078d7;color:white;cursor:pointer;height:34px;font-size:14px;}
    #pwdConfirm:hover{background-color:#005ea6;}
    body{font-family:"Microsoft YaHei",sans-serif;margin:20px;background:#fafafa;}
    #main{display:none;text-align:center;}
    #inputWrapper{position:relative;width:100%;max-width:100%;height:250px;margin-bottom:10px;}
    #placeholderText{position:absolute;top:8px;left:8px;color:#999;pointer-events:none;}
    #inputData{width:100%;height:100%;overflow-y:auto;border:1px solid #ccc;border-radius:6px;padding:8px;box-sizing:border-box;font-size:14px;line-height:1.6;white-space:pre-wrap;text-align:left;}
    button{padding:6px 14px;margin:8px 4px;border:none;border-radius:6px;background-color:#0078d7;color:white;cursor:pointer;display:inline-flex;align-items:center;height:34px;white-space:nowrap;transition:background-color .12s;}
    button:hover{background-color:#005ea6;}
    button.loading{background-color:#999;cursor:not-allowed;}
    table{border-collapse:collapse;width:100%;margin-top:10px;background:white;}
    th,td{border:1px solid #ccc;padding:6px;text-align:left;font-size:14px;vertical-align:middle;}
    th{background-color:#f0f0f0;}
    #result{margin-top:20px;overflow:auto;position:relative;background:transparent;}
    pre{width:100%;background:#f9f9f9;border:1px solid #ccc;border-radius:6px;padding:8px;white-space:pre-wrap;}
    #numInput{font-weight:600;width:100px;height:34px;text-align:center;padding:0 8px;border:1px solid #ccc;border-radius:6px;vertical-align:middle;font-size:18px;-moz-appearance:textfield;}
    #numInput::-webkit-outer-spin-button,#numInput::-webkit-inner-spin-button{-webkit-appearance:none;margin:0;}
    #numInput::placeholder{text-align:center;font-weight:normal;font-size:14px;}
    #actionButtons{display:flex;justify-content:center;flex-wrap:wrap;margin-top:10px;}
    #actionButtons button{flex:0 0 auto;}
    .queryValue{font-weight:bold;margin-bottom:6px;text-align:center;}
    .statusText{font-size:14px;color:#666;margin-top:5px;}
    .trashSvg{width:18px;height:18px;cursor:pointer;display:inline-block;vertical-align:middle;}
    .trashCell{text-align:center;}
    @media (max-width:420px){button{padding:6px 10px;font-size:13px}.trashSvg{width:16px;height:16px}}
    .deleted-mark{opacity:.45;text-decoration:line-through;}
    .highlight-row{background:yellow!important;}
    #dealAndTransfer{display:flex;flex-wrap:wrap;font-size:16px;align-items:center;column-gap:10px;font-weight:600;}
    #dealAndTransfer .item{flex:1 1 auto;min-width:120px;}
    @media (max-width:768px){#dealAndTransfer{justify-content:center}#dealAndTransfer .item:nth-child(1),#dealAndTransfer .item:nth-child(2){flex:1 1 45%;text-align:center;margin-bottom:0}#dealAndTransfer .item:nth-child(3),#dealAndTransfer .item:nth-child(4){flex:1 1 45%;text-align:center;margin-top:0}}
    #result table tr{height:30px;}
    #result table td{height:30px;line-height:20px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;padding:0 4px;vertical-align:middle;}
    @media screen and (max-width:768px){#result table tr{height:50px}#result table td{height:50px;padding:0 4px;vertical-align:middle}#result table td .multi-line{display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:3;overflow:hidden;line-height:20px;height:60px;white-space:normal;text-overflow:ellipsis;display:-webkit-box;justify-content:center}}
  </style>
</head>
<body>
<div id="passwordArea">
  <h2>è¯·è¾“å…¥å¯†ç </h2>
  <div id="pwdInputWrapper">
    <input type="password" id="pwdInput" placeholder="è¯·è¾“å…¥å¯†ç ">
  </div>
  <br>
  <button id="pwdConfirm" onclick="checkPwd()">ç¡®å®š</button>
  <p id="pwdMsg" style="color:red;"></p>
</div>
<div id="main">
  <h2>ğŸ“– ä¹¦å¸æŸ¥è¯¢å·¥å…·</h2>
  <div style="text-align:center;margin-bottom:10px;">
    <button id="refreshBtn" onclick="loadCacheTable()">ğŸ“¥ åŠ è½½ç¼“å­˜è¡¨æ ¼</button>
    <button id="loadCacheBtn" onclick="clearInputData()">ğŸ§¹ æ¸…ç©ºè¡¨æ ¼å†…å®¹</button>
    <div id="status" class="statusText">
      <span id="statusText">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åŠ è½½ç¼“å­˜è¡¨æ ¼æˆ–æ‰‹åŠ¨ç²˜è´´<a href="https://docs.qq.com/sheet/DUHFGbE54d0JDcWFT?tab=1i6wf3" target="_blank">ä½™é¢æ±‡æ€»è¡¨</a>ç²˜è´´è‡³ä¸‹æ–¹ï¼ˆæ³¨æ„ä¸è¦ç²˜è´´ä¸ºçº¯æ–‡æœ¬ï¼‰</span>
      <span id="statusMsg" style="margin-left:8px;color:red"></span>
    </div>
  </div>
  <div id="inputWrapper">
    <div id="placeholderText">è‡ªåŠ¨è·å–æˆ–æ‰‹åŠ¨ç²˜è´´è¡¨æ ¼å†…å®¹</div>
    <div id="inputData" contenteditable="true"></div>
  </div>
  <div style="margin:10px 0;text-align:center;">
    <input type="number" id="numInput" placeholder="è¾“å…¥æ‰€éœ€ä¹¦å¸">
    <button onclick="search()">ğŸ” æŸ¥è¯¢</button>
    <button id="undoBtn" onclick="undoDelete()">â†¶ æ’¤é”€åˆ é™¤</button>
  </div>
  <div id="captureArea">
    <div id="calcSection" style="display:none;flex-direction:column;align-items:center;margin-bottom:12px;font-size:16px;line-height:1.4;gap:4px;">
      <div id="needCoin" style="display:none;font-size:18px;font-weight:600;margin-bottom:0;"> æ‰€éœ€ä¹¦å¸ï¼š<span id="inputCoin" style="display:inline-block;min-width:40px">0</span></div>
      <div id="result" style="margin:0;padding:0;"></div>
      <div id="dealAndTransfer" style="display:flex;font-size:16px;align-items:center;gap:20px;font-weight:600;">
        <div>æˆäº¤ä»·ï¼š<span id="dealPrice">0.00</span></div>
        <div>åˆ°æ‰‹ä»·ï¼š<span id="afterDealPrice">0.00</span></div>
        <div>æœ¬å•èµšå–ï¼š<span id="profitPrice">0.00</span></div>
        <div>éœ€è½¬è´¦ï¼š<span id="transferResult">0.00</span></div>
      </div>
      <div id="feeOptions" style="display:flex;font-size:14px;justify-content:center;gap:25px;font-weight:normal;">
        <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="platformFee"> 6â€°äº¤æ˜“å¹³å°æœåŠ¡è´¹</label>
        <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="personalFee"> 10%ä¸ªäººæ‰‹ç»­è´¹</label>
      </div>
    </div>
  </div>
  <button id="generateImgBtn" style="display:none;">ç”ŸæˆæŸ¥è¯¢ç»“æœå›¾</button>
  <div id="imgPopup" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);justify-content:center;align-items:center;z-index:1000;flex-direction:column;">
    <div style="background:#fff;padding:12px;border-radius:8px;display:flex;flex-direction:column;align-items:center;max-width:90%;">
      <img id="generatedImg" src="" alt="æŸ¥è¯¢ç»“æœ" style="width:600px;height:auto;margin-bottom:12px;border:1px solid #ccc;">
      <div id="imgTip" style="margin-bottom:12px;font-size:14px;color:#555;text-align:center;">å¤åˆ¶å›¾ç‰‡ / ä¿å­˜å›¾ç‰‡</div>
      <div style="display:flex;gap:12px;">
        <button id="copyImgBtn" class="imgBtn">å¤åˆ¶å›¾ç‰‡</button>
        <button id="saveImgBtn" class="imgBtn">ä¿å­˜å›¾ç‰‡</button>
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
window.upperPool=window.upperPool||[];window.lowerPool=window.lowerPool||[];window.expiredPool=window.expiredPool||[];window.latestResult=window.latestResult||[];window.deletedStack=window.deletedStack||[];window.supplementStack=window.supplementStack||[];window.origPositionMap=window.origPositionMap||new Map();window.overlayButtons=window.overlayButtons||[];window.deletedIds=window.deletedIds||new Set();window.initialLatestLength=window.initialLatestLength||null;window.normalGroup=window.normalGroup||[];window.slowGroup=window.slowGroup||[];window.zhanGroup=window.zhanGroup||[];window.lowGroup=window.lowGroup||[];

var a=[107,121,110,121,125,120,41,44,44,126,115,115,119,127,115,117,114], // åŠ å¯†åçš„å¯†ç æ•°ç»„
    p="wenxindushu_pwd_ok",
    z="wenxindushu_table_cache",
    latestResult=[];
const STORAGE_KEY = p;
const CACHE_KEY = z;
function showPopup(msg, duration = 2000) {
  const popup = document.createElement("div");
  popup.innerText = msg;
  popup.style.position = "fixed";
  popup.style.top = "50%";
  popup.style.left = "50%";
  popup.style.transform = "translate(-50%,-50%)";
  popup.style.background = "rgba(0,0,0,0.8)";
  popup.style.color = "#fff";
  popup.style.padding = "12px 20px";
  popup.style.borderRadius = "6px";
  popup.style.fontSize = "14px";
  popup.style.zIndex = "10000";
  popup.style.textAlign = "center";
  document.body.appendChild(popup);
  setTimeout(() => {
    document.body.removeChild(popup)
  }, duration);
}
function checkPwd(){
  const val = document.getElementById("pwdInput").value.trim();
  let PASSWORD = '';
  for(let i=0; i<a.length; i++){
    PASSWORD += String.fromCharCode(a[i] ^ 28); 
  }
  if(val === PASSWORD){
    localStorage.setItem(STORAGE_KEY,"true");
    showMain();
  } else {
    document.getElementById("pwdMsg").innerText = "âŒ å¯†ç é”™è¯¯";
  }
}
function showMain(){
  document.getElementById("passwordArea").style.display="none";
  document.getElementById("main").style.display="block";
  document.getElementById("statusMsg").innerText = "";
  const cached = localStorage.getItem(CACHE_KEY);
  if(cached){
    const container = document.getElementById("inputData");
    container.innerHTML = cached;
    document.getElementById("placeholderText").style.display = 'none';
  }
}
window.onload=function(){if(localStorage.getItem(STORAGE_KEY)==="true")showMain()};
const inputData=document.getElementById('inputData');
const placeholderText=document.getElementById('placeholderText');
inputData.addEventListener('focus',()=>{placeholderText.style.display='none'});inputData.addEventListener('blur',()=>{if(inputData.innerText.trim()==='')placeholderText.style.display='block'});inputData.addEventListener('input',()=>{if(inputData.innerText.trim()==='')placeholderText.style.display='block';else placeholderText.style.display='none';try{localStorage.setItem(CACHE_KEY,inputData.innerHTML)}catch(e){console.warn('ç¼“å­˜ä¿å­˜å¤±è´¥',e)}});
function formatUpdateTime(submitStr){if(!submitStr)return'';const submitDate=new Date(String(submitStr).replace(/-/g,'/'));if(isNaN(submitDate))return submitStr;const submitDay=new Date(submitDate.getFullYear(),submitDate.getMonth(),submitDate.getDate());const now=new Date();const nowDay=new Date(now.getFullYear(),now.getMonth(),now.getDate());const diff=Math.floor((nowDay-submitDay)/(1000*60*60*24));if(diff===0)return'ä»Šæ—¥å†…';return diff+'å¤©å‰'}
function parseTimeToTs(str){if(!str)return null;const s=String(str).replace(/\./g,'/').replace(/å¹´|æœˆ/g,'/').replace(/æ—¥/g,'').trim();const d=new Date(s);if(!isNaN(d))return d.getTime();return null}
function loadCacheTable(){const container=document.getElementById("inputData");const cache=localStorage.getItem(CACHE_KEY);if(cache){container.innerHTML=cache;placeholderText.style.display='none'}else{showPopup("æ— ç¼“å­˜è¡¨æ ¼å¯ç”¨ï¼Œè¯·æ‰‹åŠ¨ç²˜è´´è¡¨æ ¼å†…å®¹")}}
function clearInputData(){const container=document.getElementById("inputData");container.innerHTML="";placeholderText.style.display='block';document.getElementById("statusMsg").innerText=""}
function classify(item) {if (item.æ˜¯å¦æš‚åœ) return 'å¼ƒç½®ç»„';if (item.æ˜¯å¦è¿‡æœŸ) return 'è¿‡æœŸç»„';if (item.ä¿¡ç”¨åˆ†é€»è¾‘ < 6) return 'å¼ƒç½®ç»„';if (item.ä¿¡ç”¨åˆ†é€»è¾‘ < 8) return 'ä½åˆ†ç»„';if (item.ä¿¡ç”¨åˆ†é€»è¾‘ >= 8) {if (item.æ˜¯å¦æ”’) return 'æ”’å¸ç»„';if (item.æ˜¯å¦ä¸æ¥æ€¥å•) return 'ä½é€Ÿç»„';return 'æ­£å¸¸ç»„';}}
function search(){
  const container=document.getElementById("inputData");
  const inputVal=parseFloat(document.getElementById("numInput").value);
  if(!container.querySelector('table')){showPopup("è¯·å…ˆåŠ è½½ç¼“å­˜è¡¨æ ¼æˆ–æ‰‹åŠ¨ç²˜è´´æ•°æ®");document.getElementById("result").innerHTML="";return}
  if(isNaN(inputVal)){showPopup("è¯·è¾“å…¥æœ‰æ•ˆæ•°å­—");return}
  window.deletedIds=new Set();
  window.deletedStack=[];
  window.supplementStack=[];
  window.initialLatestLength=null;
  window.currentNum=inputVal;
  const num=window.currentNum;
  const table=container.querySelector('table');
  let submitColIdx=6;
  try{
    let headerRow=table.querySelector('thead tr');
    if(!headerRow)headerRow=table.rows[0];
    if(headerRow){
      const heads=Array.from(headerRow.cells||[]).map(h=>h.innerText.trim());
      for(let i=0;i<heads.length;i++){if(/æäº¤æ—¶é—´|æ›´æ–°æ—¶é—´|æäº¤æ—¥æœŸ/.test(heads[i])){submitColIdx=i;break}}
    }
  }catch(e){}
  const rows=Array.from(table.rows).slice(1);
  function parseAccounts(row){
    const cells=row.cells;
    if(!cells||cells.length===0)return[];
    const rawCredit=(cells[0]&&cells[0].innerText)?cells[0].innerText.trim():'';
    const creditForLogic=parseFloat(rawCredit)||10;
    const name=(cells[1]&&cells[1].innerText)?cells[1].innerText.trim():'';
    const accounts=[
      cells[2]?cells[2].innerText.trim():'',
      cells[3]?cells[3].innerText.trim():'',
      cells[4]?cells[4].innerText.trim():'',
      cells[5]?cells[5].innerText.trim():''
    ];
    const submit=(cells[submitColIdx]&&cells[submitColIdx].innerText)?cells[submitColIdx].innerText.trim():'';
    const updateStr=submit;
    const list=[];
    accounts.forEach((text,k)=>{if(!text)return;const valMatch=text.replace(/,/g,'').match(/\d+(\.\d+)?/);const val=valMatch?parseFloat(valMatch[0]):null; if(val!==null){const updateTs=parseTimeToTs(updateStr)||parseTimeToTs(submit)||null;list.push({ç¾¤æ˜µç§°:name,è´¦å·:`è´¦å·${k+1}`,ä¹¦å¸:text,æäº¤æ—¶é—´:formatUpdateTime(submit),æ›´æ–°æ—¶é—´:formatUpdateTime(updateStr),æ›´æ–°æ—¶é—´_ts:updateTs,æ˜¯å¦è¿‡æœŸ:/è¿‡æœŸ|åˆ°æœŸ/.test(text),æ˜¯å¦æ”’:/æ”’/.test(text),æ˜¯å¦æš‚åœ:/æš‚åœæ¥å•/.test(text),æ˜¯å¦ä¸æ¥æ€¥å•:/ä¸æ¥æ€¥å•/.test(text),æ•°å€¼:val,ä¿¡ç”¨åˆ†:rawCredit===""?10:(parseFloat(rawCredit)||10),ä¿¡ç”¨åˆ†é€»è¾‘:creditForLogic,åŸå§‹æ—¶é—´:submit,æäº¤æ—¶é—´åŸå§‹:submit})}});
    return list;
  }
  let expiredGroup=[],normalGroup=[],slowGroup=[],zhanGroup=[],lowGroup=[],discardGroup=[];
  rows.forEach(row=>{parseAccounts(row).forEach(item=>{const g=classify(item);switch(g){case'è¿‡æœŸç»„':expiredGroup.push(item);break;case'æ­£å¸¸ç»„':normalGroup.push(item);break;case'ä½é€Ÿç»„':slowGroup.push(item);break;case'æ”’å¸ç»„':zhanGroup.push(item);break;case'ä½åˆ†ç»„':lowGroup.push(item);break;case'å¼ƒç½®ç»„':discardGroup.push(item);break}})});
  window.normalGroup=normalGroup;window.slowGroup=slowGroup;window.zhanGroup=zhanGroup;window.lowGroup=lowGroup;
  window.upperPool=[];window.lowerPool=[];window.expiredPool=[];window.latestResult=[];window.origPositionMap=new Map();window.overlayButtons=[];
  window.expiredPool=expiredGroup.filter(r=>r.æ•°å€¼>=num-10);
  const upperCandidates=[...normalGroup,...slowGroup,...zhanGroup,...lowGroup].filter(r=>!r.æ˜¯å¦è¿‡æœŸ&&r.æ•°å€¼>=num-10&&r.æ•°å€¼<num);
  const upperGroupOrder=['ä½åˆ†ç»„','æ”’å¸ç»„','ä½é€Ÿç»„','æ­£å¸¸ç»„'];
  upperCandidates.sort((a,b)=>{const ga=upperGroupOrder.indexOf(classify(a)),gb=upperGroupOrder.indexOf(classify(b));if(ga!==gb)return ga-gb;if(a.æ•°å€¼!==b.æ•°å€¼)return a.æ•°å€¼-b.æ•°å€¼;if(a.ä¿¡ç”¨åˆ†!==b.ä¿¡ç”¨åˆ†)return(b.ä¿¡ç”¨åˆ†||0)-(a.ä¿¡ç”¨åˆ†||0);return(b.æ›´æ–°æ—¶é—´_ts||0)-(a.æ›´æ–°æ—¶é—´_ts||0)});
  const firstSelected=upperCandidates.slice(Math.max(0,upperCandidates.length-3));
  window.upperPool=upperCandidates.map(r=>{if(!r._key)r._key=`${r.ç¾¤æ˜µç§°}||${r.è´¦å·}||${r.ä¹¦å¸}||${r.åŸå§‹æ—¶é—´}`;return r;});
  const lowerCandidatesAll=[...normalGroup,...slowGroup,...zhanGroup,...lowGroup].filter(r=>!r.æ˜¯å¦è¿‡æœŸ&&r.æ•°å€¼>=num);
  lowerCandidatesAll.forEach(r=>{if(!r._key)r._key=`${r.ç¾¤æ˜µç§°}||${r.è´¦å·}||${r.ä¹¦å¸}||${r.åŸå§‹æ—¶é—´}`});
  const globalMax=lowerCandidatesAll.length>0?Math.max(...lowerCandidatesAll.map(r=>r.æ•°å€¼)):num;
  const step=10;const maxSegments=200;const lowerPoolFull=[];const lowerSeen=new Set();
  for(let seg=0;seg<maxSegments;seg++){
    const start=num+seg*step;const end=start+step;
    let segItems=lowerCandidatesAll.filter(r=>r.æ•°å€¼>=start&&r.æ•°å€¼<end);
    if(segItems.length>0){
      const order=['æ­£å¸¸ç»„','ä½é€Ÿç»„','æ”’å¸ç»„','ä½åˆ†ç»„'];
      segItems.sort((a,b)=>{const ga=order.indexOf(classify(a)),gb=order.indexOf(classify(b));if(ga!==gb)return ga-gb;if(a.æ•°å€¼!==b.æ•°å€¼)return a.æ•°å€¼-b.æ•°å€¼;if(a.ä¿¡ç”¨åˆ†!==b.ä¿¡ç”¨åˆ†)return(b.ä¿¡ç”¨åˆ†||0)-(a.ä¿¡ç”¨åˆ†||0);return(b.æ›´æ–°æ—¶é—´_ts||0)-(a.æ›´æ–°æ—¶é—´_ts||0)});
      for(const it of segItems){if(!lowerSeen.has(it._key)){lowerPoolFull.push(it);lowerSeen.add(it._key)}}
    }
    if(end>=globalMax)break;
    if(seg*step>10000&&lowerPoolFull.length===0)break;
  }
  if(lowerPoolFull.length<4&&lowerCandidatesAll.length>lowerPoolFull.length){
    const remaining=lowerCandidatesAll.filter(r=>!lowerSeen.has(r._key));
    const order=['æ­£å¸¸ç»„','ä½é€Ÿç»„','æ”’å¸ç»„','ä½åˆ†ç»„'];
    remaining.sort((a,b)=>{const ga=order.indexOf(classify(a)),gb=order.indexOf(classify(b));if(ga!==gb)return ga-gb;if(a.æ•°å€¼!==b.æ•°å€¼)return a.æ•°å€¼-b.æ•°å€¼;if(a.ä¿¡ç”¨åˆ†!==b.ä¿¡ç”¨åˆ†)return(b.ä¿¡ç”¨åˆ†||0)-(a.ä¿¡ç”¨åˆ†||0);return(b.æ›´æ–°æ—¶é—´_ts||0)-(a.æ›´æ–°æ—¶é—´_ts||0)});
    for(const it of remaining){if(!lowerSeen.has(it._key)){lowerPoolFull.push(it);lowerSeen.add(it._key);if(lowerPoolFull.length>=40)break}}
  }
  window.lowerPool=lowerPoolFull.map(r=>{if(!r._key)r._key=`${r.ç¾¤æ˜µç§°}||${r.è´¦å·}||${r.ä¹¦å¸}||${r.åŸå§‹æ—¶é—´}`;return r});
  const secondSelected=lowerPoolFull.slice(0,4);
  const firstForDisplay=firstSelected.slice();
  const secondForDisplay=secondSelected.slice();
  let nonExpiredArray=[...firstForDisplay,...secondForDisplay];
  if(nonExpiredArray.length>7)nonExpiredArray=nonExpiredArray.slice(0,7);
  const allList=[...window.expiredPool,...nonExpiredArray];
  allList.forEach((r,idx)=>{if(!r._key)r._key=`${r.ç¾¤æ˜µç§°}||${r.è´¦å·}||${r.ä¹¦å¸}||${r.åŸå§‹æ—¶é—´}`;r._origPos=idx;window.origPositionMap.set(r._key,idx)});
  window.latestResult=allList;
  window.initialLatestLength=window.latestResult.length;
  updateHighlight();
  renderTableAll();
  renderCalcSection(num);
}
function getUpperSupplement(num){
  if(Array.isArray(window.upperPool)){for(let i=window.upperPool.length-1;i>=0;i--){const r=window.upperPool[i];const k=r._key;const isShown=window.latestResult&&window.latestResult.some(x=>x._key===k);const isDeleted=window.deletedIds&&window.deletedIds.has(k);const isSupped=window.supplementStack&&window.supplementStack.some(x=>x._key===k);if(!isShown&&!isDeleted&&!isSupped&&r.æ•°å€¼>=num-10&&r.æ•°å€¼<num)return r}}const all=[...window.normalGroup,...window.slowGroup,...window.zhanGroup,...window.lowGroup];all.sort((a,b)=>a.æ•°å€¼-b.æ•°å€¼);for(let i=all.length-1;i>=0;i--){const r=all[i];const k=r._key||`${r.ç¾¤æ˜µç§°}||${r.è´¦å·}||${r.ä¹¦å¸}||${r.åŸå§‹æ—¶é—´}`;if(!r._key)r._key=k;const isShown=window.latestResult&&window.latestResult.some(x=>x._key===k);const isDeleted=window.deletedIds&&window.deletedIds.has(k);if(!isShown&&!isDeleted&&r.æ•°å€¼>=num-10&&r.æ•°å€¼<num)return r}return null
}
function getLowerSupplement(num){
  if(Array.isArray(window.lowerPool)){for(let i=0;i<window.lowerPool.length;i++){const r=window.lowerPool[i];const k=r._key;const isShown=window.latestResult&&window.latestResult.some(x=>x._key===k);const isDeleted=window.deletedIds&&window.deletedIds.has(k);const isSupped=window.supplementStack&&window.supplementStack.some(x=>x._key===k);if(!isShown&&!isDeleted&&!isSupped&&r.æ•°å€¼>=num)return r}}const all=[...window.normalGroup,...window.slowGroup,...window.zhanGroup,...window.lowGroup].filter(r=>r.æ•°å€¼>=num);const order=['æ­£å¸¸ç»„','ä½é€Ÿç»„','æ”’å¸ç»„','ä½åˆ†ç»„'];all.sort((a,b)=>{const ga=order.indexOf(classify(a)),gb=order.indexOf(classify(b));if(ga!==gb)return ga-gb;if(a.æ•°å€¼!==b.æ•°å€¼)return a.æ•°å€¼-b.æ•°å€¼;if(a.ä¿¡ç”¨åˆ†!==b.ä¿¡ç”¨åˆ†)return(b.ä¿¡ç”¨åˆ†||0)-(a.ä¿¡ç”¨åˆ†||0);return(b.æ›´æ–°æ—¶é—´_ts||0)-(a.æ›´æ–°æ—¶é—´_ts||0)});for(const r of all){const k=r._key||`${r.ç¾¤æ˜µç§°}||${r.è´¦å·}||${r.ä¹¦å¸}||${r.åŸå§‹æ—¶é—´}`;if(!r._key)r._key=k;const isShown=window.latestResult&&window.latestResult.some(x=>x._key===k);const isDeleted=window.deletedIds&&window.deletedIds.has(k);if(!isShown&&!isDeleted)return r}return null}
function deleteRowByKey(key){
  if(!window.latestResult&&!window.expiredPool)return;
  const idx=window.latestResult?window.latestResult.findIndex(r=>r._key===key):-1;
  let deleted=null;let deletedFromExpired=false;let deletedExpiredIdx=-1;
  if(idx!==-1){deleted=window.latestResult.splice(idx,1)[0]}else if(Array.isArray(window.expiredPool)){const idxE=window.expiredPool.findIndex(r=>r._key===key);if(idxE!==-1){deleted=window.expiredPool.splice(idxE,1)[0];deletedFromExpired=true;deletedExpiredIdx=idxE}}
  if(!deleted)return;
  const delKey=deleted._key||`${deleted.ç¾¤æ˜µç§°}||${deleted.è´¦å·}||${deleted.ä¹¦å¸}||${deleted.åŸå§‹æ—¶é—´}`;
  if(!window.deletedIds)window.deletedIds=new Set();
  window.deletedIds.add(delKey);
  const record={deleted:deleted,supplement:null,deletedIndex:idx,deletedFromExpired:deletedFromExpired,deletedExpiredIdx:deletedExpiredIdx};
  if(!deleted.æ˜¯å¦è¿‡æœŸ){
    const num=window.currentNum;let newItem=null;
    if(deleted.æ•°å€¼<num){
      if(window.initialLatestLength===null||window.latestResult.length<window.initialLatestLength){
        newItem=getUpperSupplement(num);
        if(newItem){if(!newItem._key)newItem._key=`${newItem.ç¾¤æ˜µç§°}||${newItem.è´¦å·}||${newItem.ä¹¦å¸}||${newItem.åŸå§‹æ—¶é—´}`;const insertIndex=(window.expiredPool&&window.expiredPool.length)?window.expiredPool.length:0;window.latestResult.splice(insertIndex,0,newItem);record.supplement=newItem;window.supplementStack.push(newItem)}
      }
    }else{
      if(window.initialLatestLength===null||window.latestResult.length<window.initialLatestLength){
        newItem=getLowerSupplement(num);
        if(newItem){if(!newItem._key)newItem._key=`${newItem.ç¾¤æ˜µç§°}||${newItem.è´¦å·}||${newItem.ä¹¦å¸}||${newItem.åŸå§‹æ—¶é—´}`;window.latestResult.push(newItem);record.supplement=newItem;window.supplementStack.push(newItem)}
      }
    }
  }
  record.deleted._key=record.deleted._key||delKey;
  record.deleted._origPos=(record.deleted._origPos!==undefined)?record.deleted._origPos:record.deletedIndex;
  window.deletedStack.push(record);
  updateHighlight();
  renderTableAll();
}
function undoDelete(){
  if(!window.deletedStack||window.deletedStack.length===0)return;
  const record=window.deletedStack.pop();
  const toRestore=record.deleted;
  const sup=record.supplement;
  if(sup){const supKey=sup._key;const supIdx=window.latestResult.findIndex(x=>x._key===supKey);if(supIdx!==-1)window.latestResult.splice(supIdx,1);window.supplementStack=window.supplementStack.filter(x=>x._key!==supKey)}
  const delKey=toRestore._key||`${toRestore.ç¾¤æ˜µç§°}||${toRestore.è´¦å·}||${toRestore.ä¹¦å¸}||${toRestore.åŸå§‹æ—¶é—´}`;
  if(window.deletedIds&&window.deletedIds.delete)window.deletedIds.delete(delKey);
  if(record.deletedFromExpired){const insertIdx=(typeof record.deletedExpiredIdx==='number'&&record.deletedExpiredIdx>=0)?Math.min(record.deletedExpiredIdx,window.expiredPool.length):window.expiredPool.length;window.expiredPool.splice(insertIdx,0,toRestore)}else{const origPos=(toRestore._origPos!==undefined)?toRestore._origPos:window.latestResult.length;const insertPos=Math.min(Math.max(0,origPos),window.latestResult.length);const existingIdx=window.latestResult.findIndex(x=>x._key===toRestore._key);if(existingIdx!==-1)window.latestResult.splice(existingIdx,1);window.latestResult.splice(insertPos,0,toRestore)}
  updateHighlight();
  renderTableAll();
}
function updateHighlight(){
  const num=window.currentNum;
  const nonExpiredShown=window.latestResult?window.latestResult.filter(r=>!r.æ˜¯å¦è¿‡æœŸ):[];
  if(!nonExpiredShown||nonExpiredShown.length===0){window.highlightValue=null;window.highlightKey=null;window.highlightGroup=null;return}
  const firstLower=nonExpiredShown.find(r=>r.æ•°å€¼>=num);
  if(firstLower){window.highlightValue=firstLower.æ•°å€¼;window.highlightKey=firstLower._key;window.highlightGroup=classify(firstLower);return}
  nonExpiredShown.sort((a,b)=>{const da=Math.abs(a.æ•°å€¼-num),db=Math.abs(b.æ•°å€¼-num);if(da!==db)return da-db;const ca=(a.ä¿¡ç”¨åˆ†||0),cb=(b.ä¿¡ç”¨åˆ†||0);if(ca!==cb)return cb-ca;const ta=a.æ›´æ–°æ—¶é—´_ts||0,tb=b.æ›´æ–°æ—¶é—´_ts||0;return tb-ta});
  const chosen=nonExpiredShown[0];
  window.highlightValue=chosen?chosen.æ•°å€¼:null;window.highlightKey=chosen?chosen._key:null;window.highlightGroup=chosen?classify(chosen):null;
}
function renderTableAll(){
  const resultDiv=document.getElementById("result");
  if(!resultDiv)return;
  if(!window.overlayButtons)window.overlayButtons=[];
  window.overlayButtons.forEach(b=>b.remove());
  window.overlayButtons=[];
  const num=window.currentNum;
  let html="";
  function wrapCell(content){return`<div class="multi-wrap"><div class="multi-line">${content}</div></div>`}
  if(Array.isArray(window.expiredPool)&&window.expiredPool.length>0){
    html+="<table style='table-layout:fixed;width:100%;border-collapse:collapse;margin-bottom:4px;'><thead><tr>";
    html+="<th style='width:20%; text-align:center;'>ç¾¤æ˜µç§°</th>";
    html+="<th style='width:15%; text-align:center;'>è´¦å·</th>";
    html+="<th style='width:30%; text-align:center;'>ä¹¦å¸</th>";
    html+="<th style='width:15%; text-align:center;'>æ›´æ–°æ—¶é—´</th>";
    html+="<th style='width:10%; text-align:center;'>ä¿¡ç”¨åˆ†</th>";
    html+="<th style='width:10%; text-align:center;'>åˆ é™¤</th></tr></thead><tbody>";
    window.expiredPool.forEach(r=>{
      const style="color:#ff0000;font-weight:bold;";
      const delCell=`<div style="text-align:center;"><svg onclick="deleteRowByKey('${r._key}')" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#888888" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" style="cursor:pointer;"><path d="M7,3 a1.2,1.2 0 0 1 1.2,-1.2 h7.6 a1.2,1.2 0 0 1 1.2,1.2 v2 h-10 z" fill="none"/><line x1="2.5" y1="5" x2="21.5" y2="5"/><path d="M6,5 v14 a1.2,1.2 0 0 0 1.2,1.2 h9.6 a1.2,1.2 0 0 0 1.2,-1.2 v-14" fill="none"/><line x1="9" y1="7" x2="9" y2="17"/><line x1="12" y1="7" x2="12" y2="17"/><line x1="15" y1="7" x2="15" y2="17"/></svg></div>`;
      html+=`<tr data-key="${r._key}"><td style="text-align:center;">${r.ç¾¤æ˜µç§°}</td><td style="text-align:center;">${r.è´¦å·}</td><td style="text-align:center;${style}">${r.ä¹¦å¸}</td><td style="text-align:center;">${r.æ›´æ–°æ—¶é—´}</td><td style="text-align:center;">${r.ä¿¡ç”¨åˆ†}</td><td style="text-align:center;">${delCell}</td></tr>`;
    });
    html+="</tbody></table>";
  }
  const nonExpired=window.latestResult.filter(r=>!r.æ˜¯å¦è¿‡æœŸ);
  if(nonExpired.length>0){
    html+="<table style='table-layout:fixed;width:100%;border-collapse:collapse;'><thead><tr>";
    html+="<th style='width:20%; text-align:center;'>ç¾¤æ˜µç§°</th>";
    html+="<th style='width:15%; text-align:center;'>è´¦å·</th>";
    html+="<th style='width:30%; text-align:center;'>ä¹¦å¸</th>";
    html+="<th style='width:15%; text-align:center;'>æ›´æ–°æ—¶é—´</th>";
    html+="<th style='width:10%; text-align:center;'>ä¿¡ç”¨åˆ†</th>";
    html+="<th style='width:10%; text-align:center;'>åˆ é™¤</th></tr></thead><tbody>";
    nonExpired.forEach(r=>{
      let style="";
      const group=classify(r);
      switch(group){case'æ­£å¸¸ç»„':style="color:#333;font-weight:bold;";break;case'ä½é€Ÿç»„':style="color:#336699;";break;case'æ”’å¸ç»„':style="color:#555;";break;case'ä½åˆ†ç»„':style="color:#aaa;";break}
      const isDeletedMarked=window.deletedIds&&window.deletedIds.has(r._key);
      const isHighlight=(window.highlightKey&&r._key===window.highlightKey);
      if(isHighlight)style+="background:yellow;";
      const delCell=`<div style="text-align:center;"><svg onclick="deleteRowByKey('${r._key}')" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#888888" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" style="cursor:pointer;"><path d="M7,3 a1.2,1.2 0 0 1 1.2,-1.2 h7.6 a1.2,1.2 0 0 1 1.2,1.2 v2 h-10 z" fill="none"/><line x1="2.5" y1="5" x2="21.5" y2="5"/><path d="M6,5 v14 a1.2,1.2 0 0 0 1.2,1.2 h9.6 a1.2,1.2 0 0 0 1.2,-1.2 v-14" fill="none"/><line x1="9" y1="7" x2="9" y2="17"/><line x1="12" y1="7" x2="12" y2="17"/><line x1="15" y1="7" x2="15" y2="17"/></svg></div>`;
      html+=`<tr data-key="${r._key}" class="${isHighlight?'highlight-row':''} ${isDeletedMarked?'deleted-mark':''}"><td style="text-align:center;">${r.ç¾¤æ˜µç§°}</td><td style="text-align:center;">${r.è´¦å·}</td><td style="text-align:center;${style}">${r.ä¹¦å¸}</td><td style="text-align:center;">${r.æ›´æ–°æ—¶é—´}</td><td style="text-align:center;">${r.ä¿¡ç”¨åˆ†}</td><td style="text-align:center;">${delCell}</td></tr>`;
    });
    html+="</tbody></table>";
  }
  resultDiv.innerHTML=html;
  const actionButtonsEl=document.getElementById("actionButtons");
  if(actionButtonsEl)actionButtonsEl.style.display=window.latestResult.length?"flex":"none";
}
const EXIST_ID="dynamic-table-style";
let styleEl=document.getElementById(EXIST_ID);
if(!styleEl){styleEl=document.createElement("style");styleEl.id=EXIST_ID;document.head.appendChild(styleEl)}
styleEl.innerHTML="#result table{table-layout:fixed}#result table tr{height:30px}#result table td{height:30px;line-height:30px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;padding:0 6px;vertical-align:middle}@media screen and (max-width:768px){#result table tr{height:50px}#result table td{height:50px;line-height:normal;white-space:normal;padding:6px 6px;vertical-align:middle}#result table td .multi-wrap{display:flex;align-items:center;height:100%}#result table td .multi-wrap .multi-line{display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:3;overflow:hidden;line-height:20px;max-height:60px;white-space:normal;overflow-wrap:anywhere;word-break:break-word}}";
function renderCalcSection(num){
  const calcSection=document.getElementById("calcSection");
  const needCoin=document.getElementById("needCoin");
  const dealEl=document.getElementById("dealPrice");
  const afterDealEl=document.getElementById("afterDealPrice");
  const profitEl=document.getElementById("profitPrice");
  const transferEl=document.getElementById("transferResult");
  const pf=document.getElementById("platformFee");
  const per=document.getElementById("personalFee");
  const generateBtn=document.getElementById("generateImgBtn");
  if(needCoin){needCoin.style.display="block";needCoin.innerText=`æ‰€éœ€ä¹¦å¸ï¼š${num}`}
  const calc=()=>{
    const dealValue=Math.round(num*0.1*100)/100;
    dealEl.innerText=dealValue.toFixed(2);
    const afterDealValue=pf&&pf.checked?Math.round(dealValue*(1-0.006)*100)/100:dealValue;
    afterDealEl.innerText=afterDealValue.toFixed(2);
    const profitValue=per&&per.checked?Math.round(dealValue*0.1*100)/100:0;
    profitEl.innerText=profitValue.toFixed(2);
    const transferValue=Math.round((afterDealValue-profitValue)*100)/100;
    transferEl.innerText=transferValue.toFixed(2);
  };
  pf&&pf.addEventListener('change',calc);
  per&&per.addEventListener('change',calc);
  calc();
  if(calcSection)calcSection.style.display="flex";
  const actionButtonsEl=document.getElementById("actionButtons");
  if(actionButtonsEl)actionButtonsEl.style.display="flex";
  calcSection.style.display="flex";
  if(generateBtn){generateBtn.style.display="inline-block"}
}
async function generateResultImage(){
  const captureArea=document.getElementById("captureArea");
  if(!captureArea){showPopup("æ— æŸ¥è¯¢ç»“æœå¯æˆªå›¾");return}
  const wrapper=document.createElement('div');
  wrapper.style.width='600px';wrapper.style.padding='12px';wrapper.style.background='#fff';wrapper.style.position='absolute';wrapper.style.left='-9999px';wrapper.style.boxSizing='border-box';wrapper.style.fontFamily='Arial, sans-serif';wrapper.style.fontSize='14px';
  const clone=captureArea.cloneNode(true);clone.style.width='100%';wrapper.appendChild(clone);document.body.appendChild(wrapper);
  const canvas=await html2canvas(wrapper,{backgroundColor:null,scale:2});
  const dataUrl=canvas.toDataURL('image/png');document.body.removeChild(wrapper);
  const imgEl=document.getElementById("generatedImg");
  imgEl.src=dataUrl;imgEl.style.width='100%';imgEl.style.height='auto';imgEl.style.maxWidth='600px';imgEl.style.borderRadius='6px';imgEl.style.boxShadow='0 0 8px rgba(0,0,0,0.3)';
  const tipEl=document.getElementById("imgTip");
  if(/Android|iPhone/i.test(navigator.userAgent)){tipEl.innerText="å¤åˆ¶å¤±è´¥æ—¶å¯é•¿æŒ‰å›¾ç‰‡å¤åˆ¶æˆ–ä¿å­˜"}else{tipEl.innerText="å¤åˆ¶å¤±è´¥æ—¶å¯å³é”®å•å‡»å›¾ç‰‡å¤åˆ¶æˆ–ä¿å­˜"}
  const popup=document.getElementById("imgPopup");
  popup.style.display="flex";popup.style.position="fixed";popup.style.top="0";popup.style.left="0";popup.style.width="100%";popup.style.height="100%";popup.style.background="rgba(0,0,0,0.5)";popup.style.justifyContent="center";popup.style.alignItems="center";popup.style.padding="20px";popup.style.boxSizing="border-box";popup.style.overflow="auto";popup.style.zIndex="9999";
  popup.onclick=function(e){if(e.target===popup){popup.style.display="none"}};
}
async function copyGeneratedImg(){
  const img=document.getElementById("generatedImg");
  if(!img.src)return;
  const wrapper=document.createElement('div');
  wrapper.style.width='600px';wrapper.style.padding='12px';wrapper.style.background='#fff';wrapper.style.position='absolute';wrapper.style.left='-9999px';wrapper.style.boxSizing='border-box';wrapper.style.fontFamily='Arial, sans-serif';wrapper.style.fontSize='14px';
  const clone=document.getElementById("captureArea").cloneNode(true);
  clone.style.width='100%';wrapper.appendChild(clone);document.body.appendChild(wrapper);
  const canvas=await html2canvas(wrapper,{backgroundColor:null,scale:2});
  const blob=await new Promise(resolve=>canvas.toBlob(resolve));document.body.removeChild(wrapper);
  try{await navigator.clipboard.write([new ClipboardItem({"image/png": blob})]);showPopup("âœ… å·²å¤åˆ¶å›¾ç‰‡ï¼Œå¯ç›´æ¥ç²˜è´´åˆ°å¾®ä¿¡");  
  }catch(err){showPopup("âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶å›¾ç‰‡");console.error(err);}}
function saveGeneratedImg(){const img=document.getElementById("generatedImg");if(!img.src)return showPopup("æ— å›¾ç‰‡å¯ä¿å­˜");const link=document.createElement("a");link.href=img.src;link.download="æŸ¥è¯¢ç»“æœ.png";link.click()}
document.getElementById("generateImgBtn")?.addEventListener("click",generateResultImage);
document.getElementById("copyImgBtn")?.addEventListener("click",copyGeneratedImg);
document.getElementById("saveImgBtn")?.addEventListener("click",saveGeneratedImg);
</script>
</body>
</html>

