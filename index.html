<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>书币查询工具</title><style>body{font-family:"Microsoft YaHei",sans-serif;margin:20px;background:#fafafa}#main{display:none}#inputData{width:100%;height:200px;font-size:14px;padding:8px;border:1px solid #ccc;border-radius:6px;overflow:auto;background:white}button{padding:6px 14px;margin:8px 4px;border:none;border-radius:6px;background-color:#0078d7;color:white;cursor:pointer;display:inline-flex;align-items:center;height:34px}button:hover{background-color:#005ea6}table{border-collapse:collapse;width:100%;margin-top:10px;background:white}th,td{border:1px solid #ccc;padding:6px;text-align:left;font-size:14px}th{background-color:#f0f0f0}#result{margin-top:20px}pre{width:100%;background:#f9f9f9;border:1px solid #ccc;border-radius:6px;padding:8px;white-space:pre-wrap}input[type=number]{height:34px;font-size:14px;padding:0 8px;border:1px solid #ccc;border-radius:6px;vertical-align:middle;display:inline-flex;align-items:center}</style></head><body><div id="passwordArea"><h2>请输入密码</h2><input type="password" id="pwdInput" placeholder="请输入密码"><button onclick="checkPwd()">确定</button><p id="pwdMsg" style="color:red;"></p></div><div id="main"><h2>📖 书币查询工具</h2><p>复制<a href="https://docs.qq.com/sheet/DUHFGbE54d0JDcWFT?tab=1i6wf3" target="_blank">实时汇总表</a>粘贴至此处（注意不要粘贴为纯文本）：</p><div id="inputData" contenteditable="true" placeholder="粘贴表格内容…"></div><br><input type="number" id="numInput" placeholder="输入所需书币"><button onclick="search()">查询</button><button onclick="copyResult()">复制名单</button><button onclick="copyTableImg()">复制表格为图片</button><button onclick="downloadTableImg()">导出表格为图片</button><div id="result"></div></div><script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script><script>const P="weread500bookcoin",K="wenxindushu_pwd_ok";let R=[];function checkPwd(){let a=document.getElementById("pwdInput").value.trim();a===P?(localStorage.setItem(K,"true"),showMain()):document.getElementById("pwdMsg").innerText="❌ 密码错误"}function showMain(){document.getElementById("passwordArea").style.display="none";document.getElementById("main").style.display="block"}window.onload=function(){localStorage.getItem(K)==="true"&&showMain()};function fmtT(a){if(!a)return"";let b=new Date(a.replace(/-/g,'/'));if(isNaN(b))return a;let c=new Date(b.getFullYear(),b.getMonth(),b.getDate()),d=new Date(),e=new Date(d.getFullYear(),d.getMonth(),d.getDate()),f=Math.floor((e-c)/864e5);return f===0?"今日内":f+"天前"}const inDiv=document.getElementById("inputData");inDiv.addEventListener("paste",e=>{e.preventDefault();let t=e.clipboardData||window.clipboardData,h=t.getData("text/html"),s=t.getData("text/plain");if(h&&h.includes("<table"))inDiv.innerHTML=h;else{let r=s.trim().split(/\r?\n/).map(r=>r.trim().split(/\s+/)).filter(r=>r[0]&&r[1]&&r[5]),H="<table><tbody>";for(const i of r)H+="<tr>"+i.map(i=>`<td>${i}</td>`).join('')+"</tr>";H+="</tbody></table>";inDiv.innerHTML=H}});function search(){const a=document.getElementById("inputData"),b=parseFloat(document.getElementById("numInput").value);if(!a.innerHTML.trim()){alert("请先粘贴表格数据");return}if(isNaN(b)){alert("请输入有效数字");return}const c=a.querySelector("table");if(!c){alert("请粘贴包含表格的内容");return}const d=Array.from(c.rows).slice(1),parseRow=r=>{const t=[],e=r.cells;if(e.length<6)return[];const n=e[0].innerText.trim(),f=[e[1].innerText.trim(),e[2].innerText.trim(),e[3].innerText.trim(),e[4].innerText.trim()],g=e[5].innerText.trim();f.forEach((h,i)=>{if(!h)return;let j=h.match(/\d+(\.\d+)?/),k=j?parseFloat(j[0]):null;k!==null&&t.push({群昵称:n,账号:`账号${i+1}`,书币:h,提交时间:fmtT(g),是否过期:/过期|到期/.test(h),是否完美匹配:k===b,数值:k})});return t},sortAsc=e=>e.sort((a,b)=>a.数值-b.数值),sortDesc=e=>e.sort((a,b)=>b.数值-a.数值),sortResult=e=>e.sort((a,b)=>a.是否过期&&!b.是否过期?-1:!a.是否过期&&b.是否过期?1:a.数值-b.数值);let L=[],M=[],N=[],O=[];d.forEach(r=>{parseRow(r).forEach(i=>{i.数值>=b-2&&i.数值<b?M.push(i):i.数值>=b&&i.数值<=b+5?N.push(i):i.数值>b+5&&O.push(i);/过期|到期/.test(i.书币)&&i.数值>=b-2&&L.push(i)})});sortDesc(M);sortAsc(N);sortAsc(O);M=M.slice(0,2);let P1=[...N];if(P1.length<3){P1.push(...O.slice(0,3-P1.length))}let combined=[...L,...M,...P1],seen=new Set;combined=combined.filter(i=>{let k=i.群昵称+i.账号+i.书币;if(seen.has(k))return!1;seen.add(k);return!0});if(combined.length<3){let extra=[];d.forEach(r=>{parseRow(r).forEach(i=>{i.数值>=b-10&&i.数值<b-2&&extra.push(i)})});sortDesc(extra);combined.push(...extra.slice(0,3))}let finalResult=sortResult(combined);const minGE=finalResult.filter(r=>r.数值>=b).reduce((a,r)=>a===null?r.数值:Math.min(a,r.数值),null);R=finalResult;const resDiv=document.getElementById("result");if(finalResult.length===0){resDiv.innerHTML="<p>❌ 未找到匹配结果</p>";return}let html="<table><tr><th>群昵称</th><th>账号</th><th>书币</th><th>更新时间</th></tr>";finalResult.forEach(r=>{let s="";r.是否过期&&(s+="color:red;font-weight:bold;");r.数值===minGE&&(s+="background:yellow;");html+=`<tr><td>${r.群昵称}</td><td>${r.账号}</td><td style="${s}">${r.书币}</td><td>${r.提交时间}</td></tr>`});html+="</table>";resDiv.innerHTML=html}function copyResult(){if(!R||R.length===0){alert("无内容可复制");return}navigator.clipboard.writeText([...new Set(R.map(r=>r.群昵称))].join("\n")).then(()=>alert("✅ 名单已复制"))}function downloadTableImg(){const a=document.querySelector("#result table");if(!a){alert("无表格可导出");return}html2canvas(a).then(b=>{let c=document.createElement("a");c.download="查询结果.png";c.href=b.toDataURL();c.click()})}async function copyTableImg(){const a=document.querySelector("#result table");if(!a){alert("无表格可复制");return}try{const b=await html2canvas(a);b.toBlob(async c=>{if(!c){alert("生成图片失败");return}try{await navigator.clipboard.write([new ClipboardItem({"image/png":c})]);alert("✅ 表格已复制为图片，可直接粘贴到微信")}catch(e){alert("❌ 复制失败");console.error(e)}})}catch(e){alert("❌ 生成图片失败");console.error(e)}}</script></body></html>
